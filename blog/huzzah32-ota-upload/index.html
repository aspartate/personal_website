<!DOCTYPE html>
<html lang="en-US">
  <head>
  

  

  <title>
    
    OTA with Huzzah32 | Andrew Zhang
  </title>

  <meta name="title" content="OTA with Huzzah32 | Andrew Zhang">

  <meta charset="utf-8">
  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <base href="https://aspartate.github.io/personal_website/">

  <meta name="description" content="my personal website">

  <meta name="author" content="aspartate">

  

  <meta property="og:title" content="OTA with Huzzah32 | Andrew Zhang">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://aspartate.github.io/personal_website/">

  <meta property="og:image" content="https://aspartate.github.io/personal_website/images/osprey-delight.png">

  <meta property="og:description" content="my personal website">

  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="theme-color" content="#0097a7">

  <link rel="canonical" href="https://aspartate.github.io/personal_website/blog/huzzah32-ota-upload/">
  
  

  <link rel="stylesheet" href="https://aspartate.github.io/personal_website/style.9ff615c48229657d182d4c0c716ebf5f26645eff21662abca5e094e2b245bfeb.css" type="text/css">

  <script type="application/ld+json">
  {"@context":"http://www.schema.org","@type":"Person","@id":"https://aspartate.github.io/personal_website/","name":"aspartate","url":"https://aspartate.github.io/personal_website/","description":"my personal website","sameAs":["","https://github.com/aspartate/personal_website","","",""]}
  </script>

  <style>.lazyload{opacity:.0001;}.logo .lazyload{min-width:10em;}</style>
    <script src="https://aspartate.github.io/personal_website/js/vendor/lazysizes.min.js" async></script>
</head>

  <body>
    





<nav class="row middle-xs center-xs">
  <div class="col-xs-6 col-sm-1 logo">
    <a href="/personal_website/#"><img data-src="favicon.png" class="lazyload" lazyload="on" alt="Andrew Zhang"></a>
  </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#about">About</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#work">Work</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#blog">Blog</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#contact">Contact</a></h3>
      </div>
    
  <div class="col-xs-6 col-sm-1 nav-toggle">
      <a href="" class="nav-icon" onclick="return false">
        <i id="open" class="icon icon-2x icon-menu"></i>
      </a>
  </div>
</nav>

<section class="nav-full row middle-xs center-xs">
  <div class="col-xs-12">
    <div class="row middle-xs center-xs">
      
        <div class="col-xs-12"><h1><a href="/personal_website/#about">About</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#work">Work</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#blog">Blog</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#contact">Contact</a></h1></div>
      
    </div>
  </div>
</section>

    <main>

      <section class="container">
        <section class="content">
          <h1> OTA with Huzzah32 </h1>

            <div class="sub-header">
              March 18, 2021 Â· 6 minutes read
            </div>

          <article class="entry-content">
            <p>Annoyed with having to connect cables to your computer every time you want to push a code update to your Huzzah32? Well, there&rsquo;s this wonderful thing called Arduino OTA (over-the-air) which allows you to upload wirelessly from your home network. This would come in especially handy if, for example, your board is sealed inside some contraption you just 3D-printed.</p>
<p>One of the disadvantages of OTA is that you have to include the code for OTA as part of every sketch you upload. This allows OTA functionality to be used for the next sketch. However, this means that anything you want to upload, even a simple blink sketch, is cluttered up by over 100 lines of rather messy functions and CSS styling. I combined <strong><a href="https://lastminuteengineers.com/esp32-ota-web-updater-arduino-ide/">this tutorial</a></strong> and <strong><a href="https://www.youtube.com/watch?v=1pwqS_NUG7Q">this video</a></strong> to make a (hopefully) comprehensive and simplified workflow for OTA on the Huzzah32 board.</p>
<h3 id="1-first-upload">1. First Upload.</h3>
<p>The first upload needs to be via USB, since you need the OTA program running on the board in order to wirelessly upload future programs. Open in a new Arduino sketch and paste in the following, without any changes:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#include &lt;WiFi.h&gt;</span>
<span class="c1">#include &lt;WiFiClient.h&gt;</span>
<span class="c1">#include &lt;WebServer.h&gt;</span>
<span class="c1">#include &lt;ESPmDNS.h&gt;</span>
<span class="c1">#include &lt;Update.h&gt;</span>
<span class="c1">#include &#34;OTA.h&#34;</span>

<span class="n">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="n">setupOTA</span><span class="p">();</span> <span class="o">//</span> <span class="n">always</span> <span class="n">include</span> <span class="n">this</span> <span class="n">line</span>

  <span class="o">//</span> <span class="n">Space</span> <span class="k">for</span> <span class="n">custom</span> <span class="n">code</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">server</span><span class="o">.</span><span class="n">handleClient</span><span class="p">();</span> <span class="o">//</span> <span class="n">always</span> <span class="n">include</span> <span class="n">this</span> <span class="n">line</span>

  <span class="o">//</span> <span class="n">Space</span> <span class="k">for</span> <span class="n">custom</span> <span class="n">code</span>
<span class="p">}</span>
</code></pre></div><p>In the top right of the IDE, click the dropdown arrow and select &ldquo;New Tab&rdquo;. Name this tab &ldquo;OTA.h&rdquo;. The .h identifies this as a <em>header</em> file, which you&rsquo;ll notice is &ldquo;included&rdquo; in the code above. The purpose of this header file is to define a function <code>setupOTA()</code> which can be called from the main tab to set up the local web server. Paste the following code into the new tab:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#include &lt;WiFi.h&gt;</span>
<span class="c1">#include &lt;WiFiClient.h&gt;</span>
<span class="c1">#include &lt;WebServer.h&gt;</span>
<span class="c1">#include &lt;ESPmDNS.h&gt;</span>
<span class="c1">#include &lt;Update.h&gt;</span>

<span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;esp32&#34;</span><span class="p">;</span>
<span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">ssid</span> <span class="o">=</span> <span class="s2">&#34;XXXXXXXXXXXXXXXXXXXXX&#34;</span><span class="p">;</span>
<span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&#34;XXXXXXXXXXXXXXXXXXX&#34;</span><span class="p">;</span>
<span class="n">WebServer</span> <span class="n">server</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>

<span class="o">/*</span> <span class="n">Style</span> <span class="o">*/</span>
<span class="n">String</span> <span class="n">style</span> <span class="o">=</span>
<span class="s2">&#34;&lt;style&gt;#file-input,input{width:100%;height:44px;border-radius:4px;margin:10px auto;font-size:15px}&#34;</span>
<span class="s2">&#34;input{background:#f1f1f1;border:0;padding:0 15px}body{background:#3498db;font-family:sans-serif;font-size:14px;color:#777}&#34;</span>
<span class="s2">&#34;#file-input{padding:0;border:1px solid #ddd;line-height:44px;text-align:left;display:block;cursor:pointer}&#34;</span>
<span class="s2">&#34;#bar,#prgbar{background-color:#f1f1f1;border-radius:10px}#bar{background-color:#3498db;width:0%;height:10px}&#34;</span>
<span class="s2">&#34;form{background:#fff;max-width:258px;margin:75px auto;padding:30px;border-radius:5px;text-align:center}&#34;</span>
<span class="s2">&#34;.btn{background:#3498db;color:#fff;cursor:pointer}&lt;/style&gt;&#34;</span><span class="p">;</span>

<span class="o">/*</span> <span class="n">Login</span> <span class="n">page</span> <span class="o">*/</span>
<span class="n">String</span> <span class="n">loginIndex</span> <span class="o">=</span> 
<span class="s2">&#34;&lt;form name=loginForm&gt;&#34;</span>
<span class="s2">&#34;&lt;h1&gt;ESP32 Login&lt;/h1&gt;&#34;</span>
<span class="s2">&#34;&lt;input name=userid placeholder=&#39;User ID&#39;&gt; &#34;</span>
<span class="s2">&#34;&lt;input name=pwd placeholder=Password type=Password&gt; &#34;</span>
<span class="s2">&#34;&lt;input type=submit onclick=check(this.form) class=btn value=Login&gt;&lt;/form&gt;&#34;</span>
<span class="s2">&#34;&lt;script&gt;&#34;</span>
<span class="s2">&#34;function check(form) {&#34;</span>
<span class="s2">&#34;if(form.userid.value==&#39;admin&#39; &amp;&amp; form.pwd.value==&#39;admin&#39;)&#34;</span>
<span class="s2">&#34;{window.open(&#39;/serverIndex&#39;)}&#34;</span>
<span class="s2">&#34;else&#34;</span>
<span class="s2">&#34;{alert(&#39;Error Password or Username&#39;)}&#34;</span>
<span class="s2">&#34;}&#34;</span>
<span class="s2">&#34;&lt;/script&gt;&#34;</span> <span class="o">+</span> <span class="n">style</span><span class="p">;</span>
 
<span class="o">/*</span> <span class="n">Server</span> <span class="n">Index</span> <span class="n">Page</span> <span class="o">*/</span>
<span class="n">String</span> <span class="n">serverIndex</span> <span class="o">=</span> 
<span class="s2">&#34;&lt;script src=&#39;https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js&#39;&gt;&lt;/script&gt;&#34;</span>
<span class="s2">&#34;&lt;form method=&#39;POST&#39; action=&#39;#&#39; enctype=&#39;multipart/form-data&#39; id=&#39;upload_form&#39;&gt;&#34;</span>
<span class="s2">&#34;&lt;input type=&#39;file&#39; name=&#39;update&#39; id=&#39;file&#39; onchange=&#39;sub(this)&#39; style=display:none&gt;&#34;</span>
<span class="s2">&#34;&lt;label id=&#39;file-input&#39; for=&#39;file&#39;&gt;   Choose file...&lt;/label&gt;&#34;</span>
<span class="s2">&#34;&lt;input type=&#39;submit&#39; class=btn value=&#39;Update&#39;&gt;&#34;</span>
<span class="s2">&#34;&lt;br&gt;&lt;br&gt;&#34;</span>
<span class="s2">&#34;&lt;div id=&#39;prg&#39;&gt;&lt;/div&gt;&#34;</span>
<span class="s2">&#34;&lt;br&gt;&lt;div id=&#39;prgbar&#39;&gt;&lt;div id=&#39;bar&#39;&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/form&gt;&#34;</span>
<span class="s2">&#34;&lt;script&gt;&#34;</span>
<span class="s2">&#34;function sub(obj){&#34;</span>
<span class="s2">&#34;var fileName = obj.value.split(&#39;</span><span class="se">\\\\</span><span class="s2">&#39;);&#34;</span>
<span class="s2">&#34;document.getElementById(&#39;file-input&#39;).innerHTML = &#39;   &#39;+ fileName[fileName.length-1];&#34;</span>
<span class="s2">&#34;};&#34;</span>
<span class="s2">&#34;$(&#39;form&#39;).submit(function(e){&#34;</span>
<span class="s2">&#34;e.preventDefault();&#34;</span>
<span class="s2">&#34;var form = $(&#39;#upload_form&#39;)[0];&#34;</span>
<span class="s2">&#34;var data = new FormData(form);&#34;</span>
<span class="s2">&#34;$.ajax({&#34;</span>
<span class="s2">&#34;url: &#39;/update&#39;,&#34;</span>
<span class="s2">&#34;type: &#39;POST&#39;,&#34;</span>
<span class="s2">&#34;data: data,&#34;</span>
<span class="s2">&#34;contentType: false,&#34;</span>
<span class="s2">&#34;processData:false,&#34;</span>
<span class="s2">&#34;xhr: function() {&#34;</span>
<span class="s2">&#34;var xhr = new window.XMLHttpRequest();&#34;</span>
<span class="s2">&#34;xhr.upload.addEventListener(&#39;progress&#39;, function(evt) {&#34;</span>
<span class="s2">&#34;if (evt.lengthComputable) {&#34;</span>
<span class="s2">&#34;var per = evt.loaded / evt.total;&#34;</span>
<span class="s2">&#34;$(&#39;#prg&#39;).html(&#39;progress: &#39; + Math.round(per*100) + &#39;%&#39;);&#34;</span>
<span class="s2">&#34;$(&#39;#bar&#39;).css(&#39;width&#39;,Math.round(per*100) + &#39;%&#39;);&#34;</span>
<span class="s2">&#34;}&#34;</span>
<span class="s2">&#34;}, false);&#34;</span>
<span class="s2">&#34;return xhr;&#34;</span>
<span class="s2">&#34;},&#34;</span>
<span class="s2">&#34;success:function(d, s) {&#34;</span>
<span class="s2">&#34;console.log(&#39;success!&#39;) &#34;</span>
<span class="s2">&#34;},&#34;</span>
<span class="s2">&#34;error: function (a, b, c) {&#34;</span>
<span class="s2">&#34;}&#34;</span>
<span class="s2">&#34;});&#34;</span>
<span class="s2">&#34;});&#34;</span>
<span class="s2">&#34;&lt;/script&gt;&#34;</span> <span class="o">+</span> <span class="n">style</span><span class="p">;</span>

<span class="o">/*</span> <span class="n">setup</span> <span class="n">function</span> <span class="o">*/</span>
<span class="n">void</span> <span class="n">setupOTA</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">WiFi</span> <span class="n">network</span>
  <span class="n">WiFi</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">connection</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Connected to &#34;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&#34;IP address: &#34;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">WiFi</span><span class="o">.</span><span class="n">localIP</span><span class="p">());</span>

  <span class="o">/*</span><span class="n">use</span> <span class="n">mdns</span> <span class="k">for</span> <span class="n">host</span> <span class="n">name</span> <span class="n">resolution</span><span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">MDNS</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span> <span class="o">//</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">esp32</span><span class="o">.</span><span class="n">local</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Error setting up MDNS responder!&#34;</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;mDNS responder started&#34;</span><span class="p">);</span>
  <span class="o">/*</span><span class="k">return</span> <span class="n">index</span> <span class="n">page</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">serverIndex</span> <span class="o">*/</span>
  <span class="n">server</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="n">HTTP_GET</span><span class="p">,</span> <span class="p">[]()</span> <span class="p">{</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendHeader</span><span class="p">(</span><span class="s2">&#34;Connection&#34;</span><span class="p">,</span> <span class="s2">&#34;close&#34;</span><span class="p">);</span>
    <span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&#34;text/html&#34;</span><span class="p">,</span> <span class="n">loginIndex</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="n">server</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&#34;/serverIndex&#34;</span><span class="p">,</span> <span class="n">HTTP_GET</span><span class="p">,</span> <span class="p">[]()</span> <span class="p">{</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendHeader</span><span class="p">(</span><span class="s2">&#34;Connection&#34;</span><span class="p">,</span> <span class="s2">&#34;close&#34;</span><span class="p">);</span>
    <span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&#34;text/html&#34;</span><span class="p">,</span> <span class="n">serverIndex</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="o">/*</span><span class="n">handling</span> <span class="n">uploading</span> <span class="n">firmware</span> <span class="nb">file</span> <span class="o">*/</span>
  <span class="n">server</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&#34;/update&#34;</span><span class="p">,</span> <span class="n">HTTP_POST</span><span class="p">,</span> <span class="p">[]()</span> <span class="p">{</span>
    <span class="n">server</span><span class="o">.</span><span class="n">sendHeader</span><span class="p">(</span><span class="s2">&#34;Connection&#34;</span><span class="p">,</span> <span class="s2">&#34;close&#34;</span><span class="p">);</span>
    <span class="n">server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&#34;text/plain&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">Update</span><span class="o">.</span><span class="n">hasError</span><span class="p">())</span> <span class="err">?</span> <span class="s2">&#34;FAIL&#34;</span> <span class="p">:</span> <span class="s2">&#34;OK&#34;</span><span class="p">);</span>
    <span class="n">ESP</span><span class="o">.</span><span class="n">restart</span><span class="p">();</span>
  <span class="p">},</span> <span class="p">[]()</span> <span class="p">{</span>
    <span class="n">HTTPUpload</span><span class="o">&amp;</span> <span class="n">upload</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">upload</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">upload</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UPLOAD_FILE_START</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="o">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;Update: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">upload</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">c_str</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">Update</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">UPDATE_SIZE_UNKNOWN</span><span class="p">))</span> <span class="p">{</span> <span class="o">//</span><span class="n">start</span> <span class="k">with</span> <span class="nb">max</span> <span class="n">available</span> <span class="n">size</span>
        <span class="n">Update</span><span class="o">.</span><span class="n">printError</span><span class="p">(</span><span class="n">Serial</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">upload</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UPLOAD_FILE_WRITE</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">/*</span> <span class="n">flashing</span> <span class="n">firmware</span> <span class="n">to</span> <span class="n">ESP</span><span class="o">*/</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Update</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">upload</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">upload</span><span class="o">.</span><span class="n">currentSize</span><span class="p">)</span> <span class="o">!=</span> <span class="n">upload</span><span class="o">.</span><span class="n">currentSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Update</span><span class="o">.</span><span class="n">printError</span><span class="p">(</span><span class="n">Serial</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">upload</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">UPLOAD_FILE_END</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Update</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">true</span><span class="p">))</span> <span class="p">{</span> <span class="o">//</span><span class="n">true</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">size</span> <span class="n">to</span> <span class="n">the</span> <span class="n">current</span> <span class="n">progress</span>
        <span class="n">Serial</span><span class="o">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;Update Success: </span><span class="si">%u</span><span class="se">\n</span><span class="s2">Rebooting...</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">upload</span><span class="o">.</span><span class="n">totalSize</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">Update</span><span class="o">.</span><span class="n">printError</span><span class="p">(</span><span class="n">Serial</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="n">server</span><span class="o">.</span><span class="n">begin</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div><p>Change the lines of Xs to your WiFi SSID and password, respectively. Save the sketch and go to &ldquo;Sketch&rdquo; &gt; &ldquo;Show Sketch Folder&rdquo;. You should see 2 items: an Arduino file and an H file. Then connect your Huzzah32 to the computer and click upload from the IDE.</p>
<p>Next, open the Serial Monitor and press the reset button on the Huzzah. After a while, you should see an IP address pop up. If you get stuck at this step, double-check your SSID and password or move to an area with better WiFi.</p>
<p>Paste that IP address into your browser address bar and you should see the following page:</p>
<p><img src="images/huzzah32-ota/login-page.png" alt="Login page."></p>
<p>The username and password are both &ldquo;admin&rdquo;. (This can be changed in the OTA.h code above.) <strong>Note that this portal is not secure anyways, since the login page can be bypassed by going to the URL of the next page directly.</strong></p>
<p>You should now see the following:</p>
<p><img src="images/huzzah32-ota/upload-page.png" alt="Upload page."></p>
<p>If so, you have successfully set up OTA on your Huzzah32. Bookmark either the login page or upload page for future reference. Disconnect it from the computer and plug the microUSB cable into a battery pack or wall adapter. Time for the fun part!</p>
<h3 id="2-wireless-uploading">2. Wireless Uploading</h3>
<p>Refresh the login or upload page and verify that the portal shows up. If so, your Huzzah32 is connected to your WiFi network and is ready to receive code. Go back to your Arduino sketch and put whatever code you want in the designated spaces in the first tab (labeled &ldquo;Space for custom code&rdquo;). Do not touch the second tab (OTA.h). If you&rsquo;d like a simple blink sketch to experiment with, clear everything in your main tab and copy-paste the following into it:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#include &lt;WiFi.h&gt;</span>
<span class="c1">#include &lt;WiFiClient.h&gt;</span>
<span class="c1">#include &lt;WebServer.h&gt;</span>
<span class="c1">#include &lt;ESPmDNS.h&gt;</span>
<span class="c1">#include &lt;Update.h&gt;</span>
<span class="c1">#include &#34;OTA.h&#34;</span>

<span class="o">//</span><span class="n">Blinking</span> <span class="n">an</span> <span class="n">LED</span> <span class="k">with</span> <span class="n">millis</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">led</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span> <span class="o">//</span> <span class="n">Huzzah32</span> <span class="n">GPIO</span> <span class="n">pin</span> <span class="n">to</span> <span class="n">which</span> <span class="n">LED</span> <span class="ow">is</span> <span class="n">connected</span>
<span class="n">unsigned</span> <span class="nb">long</span> <span class="n">previousMillis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="o">//</span> <span class="n">will</span> <span class="n">store</span> <span class="n">last</span> <span class="n">time</span> <span class="n">LED</span> <span class="n">was</span> <span class="n">updated</span>
<span class="n">const</span> <span class="nb">long</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>  <span class="o">//</span> <span class="n">interval</span> <span class="n">at</span> <span class="n">which</span> <span class="n">to</span> <span class="n">blink</span> <span class="p">(</span><span class="n">milliseconds</span><span class="p">)</span>
<span class="nb">int</span> <span class="n">ledState</span> <span class="o">=</span> <span class="n">LOW</span><span class="p">;</span>  <span class="o">//</span> <span class="n">ledState</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">LED</span>

<span class="n">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="n">setupOTA</span><span class="p">();</span> <span class="o">//</span><span class="n">always</span> <span class="n">include</span>
  
  <span class="n">pinMode</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">server</span><span class="o">.</span><span class="n">handleClient</span><span class="p">();</span> <span class="o">//</span><span class="n">always</span> <span class="n">include</span>
  
  <span class="n">unsigned</span> <span class="nb">long</span> <span class="n">currentMillis</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">currentMillis</span> <span class="o">-</span> <span class="n">previousMillis</span> <span class="o">&gt;=</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
  	<span class="n">previousMillis</span> <span class="o">=</span> <span class="n">currentMillis</span><span class="p">;</span>
  	<span class="n">ledState</span> <span class="o">=</span> <span class="ow">not</span><span class="p">(</span><span class="n">ledState</span><span class="p">);</span>
  	<span class="n">digitalWrite</span><span class="p">(</span><span class="n">led</span><span class="p">,</span>  <span class="n">ledState</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>After saving, go to &ldquo;Sketch&rdquo; &gt; &ldquo;Export compiled Binary&rdquo;. Then go to &ldquo;Sketch&rdquo; &gt; &ldquo;Show Sketch Folder&rdquo; to see if the binary file (.BIN) is there. Upload the binary file into the upload page in your browser, and click &ldquo;Update&rdquo;.</p>
<p><img src="images/huzzah32-ota/uploading.png" alt="Uploading."></p>
<p>When the progress bar reaches 100%, your code has been successfully uploaded. If your Huzzah32 isn&rsquo;t doing anything, double-check that your pin definitions are correct. Refer to the helpful diagram below, courtesy of the <strong><a href="https://makeabilitylab.github.io/physcomp/esp32/pot-fade.html#the-code">Makeability Lab</a></strong>:</p>
<p><img src="images/huzzah32-ota/huzzah32-pins.png" alt="Huzzah32 Pin Definitions."></p>
<p>For all code updates in the future, just make a copy of the entire Arduino sketch folder (make sure to include the OTA.h file, though you can delete the binary file) and change the custom code part in the main tab. One caveat to be mindful of: <strong>always</strong> use <code>millis()</code> instead of <code>delay()</code>, because the latter will interfere with the WiFi.</p>
<p>Enjoy your new wireless Huzzah32! From now on, as long as it is powered on and within range of the stored network, you can upload code through the browser portal.</p>

          </article>

          <div class="pagination">
            
              <a href="https://aspartate.github.io/personal_website/blog/week-7-input-output/">&laquo; Week 7 - Input/Output</a>
            
            
          </div>
        </section>
        <br>
        <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;
      var disqus_shortname = '';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view comments powered by <a href="http://disqus.com/?ref_noscript">Disqus</a>.</noscript>
</section>

      </section>

    </main>
    <footer class="row middle-xs center-xs">
  <div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-facebook"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href="https://github.com/aspartate/personal_website"><i class="icon icon-github"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-linkedin"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-stackoverflow"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-twitter"></i></a>
    </div>
  <div class="col-xs-12">
      <small>
      
      Copyright &copy; 2021 Andrew Zhang
      
      
      </small>
    </div>
</footer>

    






  <script src="https://aspartate.github.io/personal_website/js/bundle.min.fbd35181a0fd0238360575e6a25942746d4e73c615f852efe3b975ea70829339.js" type="text/javascript"></script>
  <script>handleNavBar( false )</script>

  </body>
</html>