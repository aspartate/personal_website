<!DOCTYPE html>
<html lang="en-US">
  <head>
  

  

  <title>
    
    Week 8 - ESP-NOW Servo Control | Andrew Zhang
  </title>

  <meta name="title" content="Week 8 - ESP-NOW Servo Control | Andrew Zhang">

  <meta charset="utf-8">
  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <base href="https://aspartate.github.io/personal_website/">

  <meta name="description" content="my personal website">

  <meta name="author" content="aspartate">

  

  <meta property="og:title" content="Week 8 - ESP-NOW Servo Control | Andrew Zhang">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://aspartate.github.io/personal_website/">

  <meta property="og:image" content="https://aspartate.github.io/personal_website/images/osprey-delight.png">

  <meta property="og:description" content="my personal website">

  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="theme-color" content="#0097a7">

  <link rel="canonical" href="https://aspartate.github.io/personal_website/blog/week-8-espnow/">
  
  

  <link rel="stylesheet" href="https://aspartate.github.io/personal_website/style.9ff615c48229657d182d4c0c716ebf5f26645eff21662abca5e094e2b245bfeb.css" type="text/css">

  <script type="application/ld+json">
  {"@context":"http://www.schema.org","@type":"Person","@id":"https://aspartate.github.io/personal_website/","name":"aspartate","url":"https://aspartate.github.io/personal_website/","description":"my personal website","sameAs":["","https://github.com/aspartate/personal_website","","",""]}
  </script>

  <style>.lazyload{opacity:.0001;}.logo .lazyload{min-width:10em;}</style>
    <script src="https://aspartate.github.io/personal_website/js/vendor/lazysizes.min.js" async></script>
</head>

  <body>
    





<nav class="row middle-xs center-xs">
  <div class="col-xs-6 col-sm-1 logo">
    <a href="/personal_website/#"><img data-src="favicon.png" class="lazyload" lazyload="on" alt="Andrew Zhang"></a>
  </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#about">About</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#work">Work</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#blog">Blog</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#contact">Contact</a></h3>
      </div>
    
  <div class="col-xs-6 col-sm-1 nav-toggle">
      <a href="" class="nav-icon" onclick="return false">
        <i id="open" class="icon icon-2x icon-menu"></i>
      </a>
  </div>
</nav>

<section class="nav-full row middle-xs center-xs">
  <div class="col-xs-12">
    <div class="row middle-xs center-xs">
      
        <div class="col-xs-12"><h1><a href="/personal_website/#about">About</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#work">Work</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#blog">Blog</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#contact">Contact</a></h1></div>
      
    </div>
  </div>
</section>

    <main>

      <section class="container">
        <section class="content">
          <h1> Week 8 - ESP-NOW Servo Control </h1>

            <div class="sub-header">
              March 23, 2021 Â· 4 minutes read
            </div>

          <article class="entry-content">
            <p>The assignment for this week was to implement an input/output system over the ESP-NOW radio protocol. I had access to two ESP32 boards: the ESP32-CAM and the Huzzah32. The CAM was a source of many hours of debugging because it does not appear to be optimized for GPIO. Therefore I plan to repeat this project with a standard ESP32 Dev Board or ESP8266, which should be much more straightforward.</p>
<p>I followed <strong><a href="https://randomnerdtutorials.com/esp-now-esp32-arduino-ide/">this tutorial</a></strong> to set up ESP-NOW. First, I set the CAM as the sender and the Huzzah32 as the receiver. I did get ESP32 up and running with minimal fuss, and the default packet of information (containing a character, integer, float, string, and boolean) was sent from the Huzzah to the CAM reliably as long as both were turned on.</p>
<p>I then wanted to modify the code to accept the reading from a potentiometer as input. This is where my troubles with the CAM began. While running ESP-NOW, I could not get the CAM to accept an analog input via <code>analogRead</code> regardless of which pin I used. When I turned off ESP-NOW, <code>analogRead</code> would work fine. After several hours of research and trying to find a workaround, I concluded that there must be some conflict with analog-to-digital conversion (ADC) and WiFi on the CAM. I&rsquo;m not sure of ESP-NOW technically counts as WiFi or not, but it does use the WiFi library so I figured that was the source of my problems.</p>
<p>At one point while debugging the CAM I got tired of having to short the GPIO0/GND pins by attaching and removing a jumper every time I wanted to flash new code. Therefore I made a pushbutton device that I could just leave on the two pins and press (along with the RESET button) when flashing code. This was simply a pushbutton attached to two Dupont connectors (sacrificed from a jumper cable) and wrapped in some electrical tape:</p>
<p><img src="images/week8-radio/pushbutton_jumper.jpg" alt="Pushbutton jumper."></p>
<p>Eventually I decided to switch the receiver and sender identities, so that the CAM was now the receiver. This meant I could use the Huzzah to read the potentiometer value, and that worked well. My code involved minimal changes from the tutorial, only replacing one of the values in the data packet with an <code>analogRead</code> from pin 32. Here is the code:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">/*</span>
  <span class="n">Rui</span> <span class="n">Santos</span>
  <span class="n">Complete</span> <span class="n">project</span> <span class="n">details</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">RandomNerdTutorials</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">esp</span><span class="o">-</span><span class="n">now</span><span class="o">-</span><span class="n">esp32</span><span class="o">-</span><span class="n">arduino</span><span class="o">-</span><span class="n">ide</span><span class="o">/</span>
  
  <span class="n">Permission</span> <span class="ow">is</span> <span class="n">hereby</span> <span class="n">granted</span><span class="p">,</span> <span class="n">free</span> <span class="n">of</span> <span class="n">charge</span><span class="p">,</span> <span class="n">to</span> <span class="nb">any</span> <span class="n">person</span> <span class="n">obtaining</span> <span class="n">a</span> <span class="n">copy</span>
  <span class="n">of</span> <span class="n">this</span> <span class="n">software</span> <span class="ow">and</span> <span class="n">associated</span> <span class="n">documentation</span> <span class="n">files</span><span class="o">.</span>
  
  <span class="n">The</span> <span class="n">above</span> <span class="n">copyright</span> <span class="n">notice</span> <span class="ow">and</span> <span class="n">this</span> <span class="n">permission</span> <span class="n">notice</span> <span class="n">shall</span> <span class="n">be</span> <span class="n">included</span> <span class="ow">in</span> <span class="nb">all</span>
  <span class="n">copies</span> <span class="ow">or</span> <span class="n">substantial</span> <span class="n">portions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Software</span><span class="o">.</span>
<span class="o">*/</span>

<span class="c1">#include &lt;esp_now.h&gt;</span>
<span class="c1">#include &lt;WiFi.h&gt;</span>

<span class="n">uint8_t</span> <span class="n">broadcastAddress</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span> <span class="o">//</span> <span class="n">REPLACE</span> <span class="n">WITH</span> <span class="n">YOUR</span> <span class="n">RECEIVER</span> <span class="n">MAC</span> <span class="n">Address</span>

<span class="nb">int</span> <span class="n">potpin</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">pot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Structure</span> <span class="n">example</span> <span class="n">to</span> <span class="n">send</span> <span class="n">data</span>
<span class="o">//</span> <span class="n">Must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">receiver</span> <span class="n">structure</span>
<span class="n">typedef</span> <span class="n">struct</span> <span class="n">struct_message</span> <span class="p">{</span>
  <span class="n">char</span> <span class="n">a</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="nb">int</span> <span class="n">b</span><span class="p">;</span>
  <span class="nb">float</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">String</span> <span class="n">d</span><span class="p">;</span>
  <span class="nb">bool</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span> <span class="n">struct_message</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">struct_message</span> <span class="n">called</span> <span class="n">myData</span>
<span class="n">struct_message</span> <span class="n">myData</span><span class="p">;</span>
 
<span class="n">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Init</span> <span class="n">Serial</span> <span class="n">Monitor</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
 
  <span class="o">//</span> <span class="n">Set</span> <span class="n">device</span> <span class="k">as</span> <span class="n">a</span> <span class="n">Wi</span><span class="o">-</span><span class="n">Fi</span> <span class="n">Station</span>
  <span class="n">WiFi</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">WIFI_STA</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">Init</span> <span class="n">ESP</span><span class="o">-</span><span class="n">NOW</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">esp_now_init</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ESP_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Error initializing ESP-NOW&#34;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">//</span> <span class="n">Once</span> <span class="n">ESPNow</span> <span class="ow">is</span> <span class="n">successfully</span> <span class="n">Init</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">register</span> <span class="k">for</span> <span class="n">Send</span> <span class="n">CB</span> <span class="n">to</span>
  <span class="o">//</span> <span class="n">get</span> <span class="n">the</span> <span class="n">status</span> <span class="n">of</span> <span class="n">Trasnmitted</span> <span class="n">packet</span>
  <span class="n">esp_now_register_send_cb</span><span class="p">(</span><span class="n">OnDataSent</span><span class="p">);</span>
  
  <span class="o">//</span> <span class="n">Register</span> <span class="n">peer</span>
  <span class="n">esp_now_peer_info_t</span> <span class="n">peerInfo</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">peerInfo</span><span class="o">.</span><span class="n">peer_addr</span><span class="p">,</span> <span class="n">broadcastAddress</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">peerInfo</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
  <span class="n">peerInfo</span><span class="o">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
  
  <span class="o">//</span> <span class="n">Add</span> <span class="n">peer</span>        
  <span class="k">if</span> <span class="p">(</span><span class="n">esp_now_add_peer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peerInfo</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ESP_OK</span><span class="p">){</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Failed to add peer&#34;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="n">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pot</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="n">potpin</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4095</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Potentiometer reading:&#34;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">pot</span><span class="p">);</span>
  
  <span class="o">//</span> <span class="n">Set</span> <span class="n">values</span> <span class="n">to</span> <span class="n">send</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">myData</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="s2">&#34;THIS IS A CHAR&#34;</span><span class="p">);</span>
  <span class="n">myData</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">pot</span><span class="p">;</span>
  <span class="n">myData</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">;</span>
  <span class="n">myData</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="s2">&#34;Hello&#34;</span><span class="p">;</span>
  <span class="n">myData</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Send</span> <span class="n">message</span> <span class="n">via</span> <span class="n">ESP</span><span class="o">-</span><span class="n">NOW</span>
  <span class="n">esp_err_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">esp_now_send</span><span class="p">(</span><span class="n">broadcastAddress</span><span class="p">,</span> <span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">myData</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">myData</span><span class="p">));</span>
   
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ESP_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Sent with success&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Error sending the data&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>


<span class="o">//</span> <span class="n">callback</span> <span class="n">when</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">sent</span>
<span class="n">void</span> <span class="n">OnDataSent</span><span class="p">(</span><span class="n">const</span> <span class="n">uint8_t</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">esp_now_send_status_t</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">Last Packet Send Status:</span><span class="se">\t</span><span class="s2">&#34;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ESP_NOW_SEND_SUCCESS</span> <span class="err">?</span> <span class="s2">&#34;Delivery Success&#34;</span> <span class="p">:</span> <span class="s2">&#34;Delivery Fail&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>I could reliably get the values from the potentiometeron the Huzzah to be output on the CAM serial monitor.</p>
<p><img src="images/week8-radio/input_pot.gif" alt="Potentiometer input.">
<img src="images/week8-radio/output_sm.gif" alt="Serial monitor output."></p>
<p>The next step was to use the potentiometer value received by the CAM (with a range of 0-180) to drive a servo. Alas, the CAM again debunked my illusions of this being a straightforward task. I tried both the <code>&lt;esp32-hal-ledc.h&gt;</code> and <code>ESP32Servo.h</code> libraries, but neither would work, even on a fresh sketch without ESP-NOW. The servo would either not budge at all or emit a whining sound that told me it was not happy. Both the CAM and the servo would also get concerningly hot.</p>
<p>To be debugged&hellip;</p>

          </article>

          <div class="pagination">
            
              <a href="https://aspartate.github.io/personal_website/blog/week-8-huzzah32-ota/">&laquo; Week 8 - OTA with Huzzah32</a>
            
            
              <a href="https://aspartate.github.io/personal_website/blog/week-9-cloud/">Week 9 - The Cloud &raquo;</a>
            
          </div>
        </section>
        <br>
        <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;
      var disqus_shortname = '';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view comments powered by <a href="http://disqus.com/?ref_noscript">Disqus</a>.</noscript>
</section>

      </section>

    </main>
    <footer class="row middle-xs center-xs">
  <div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-facebook"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href="https://github.com/aspartate/personal_website"><i class="icon icon-github"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-linkedin"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-stackoverflow"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-twitter"></i></a>
    </div>
  <div class="col-xs-12">
      <small>
      
      Copyright &copy; 2021 Andrew Zhang
      
      
      </small>
    </div>
</footer>

    






  <script src="https://aspartate.github.io/personal_website/js/bundle.min.fbd35181a0fd0238360575e6a25942746d4e73c615f852efe3b975ea70829339.js" type="text/javascript"></script>
  <script>handleNavBar( false )</script>

  </body>
</html>