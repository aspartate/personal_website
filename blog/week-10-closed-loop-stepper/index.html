<!DOCTYPE html>
<html lang="en-US">
  <head>
  

  

  <title>
    
    Week 10 - DIY Closed-Loop Stepper | Andrew Zhang
  </title>

  <meta name="title" content="Week 10 - DIY Closed-Loop Stepper | Andrew Zhang">

  <meta charset="utf-8">
  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <base href="https://aspartate.github.io/personal_website/">

  <meta name="description" content="my personal website">

  <meta name="author" content="aspartate">

  

  <meta property="og:title" content="Week 10 - DIY Closed-Loop Stepper | Andrew Zhang">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://aspartate.github.io/personal_website/">

  <meta property="og:image" content="https://aspartate.github.io/personal_website/images/osprey-delight.png">

  <meta property="og:description" content="my personal website">

  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="theme-color" content="#0097a7">

  <link rel="canonical" href="https://aspartate.github.io/personal_website/blog/week-10-closed-loop-stepper/">
  
  

  <link rel="stylesheet" href="https://aspartate.github.io/personal_website/style.9ff615c48229657d182d4c0c716ebf5f26645eff21662abca5e094e2b245bfeb.css" type="text/css">

  <script type="application/ld+json">
  {"@context":"http://www.schema.org","@type":"Person","@id":"https://aspartate.github.io/personal_website/","name":"aspartate","url":"https://aspartate.github.io/personal_website/","description":"my personal website","sameAs":["","https://github.com/aspartate/personal_website","","",""]}
  </script>

  <style>.lazyload{opacity:.0001;}.logo .lazyload{min-width:10em;}</style>
    <script src="https://aspartate.github.io/personal_website/js/vendor/lazysizes.min.js" async></script>
</head>

  <body>
    





<nav class="row middle-xs center-xs">
  <div class="col-xs-6 col-sm-1 logo">
    <a href="/personal_website/#"><img data-src="favicon.png" class="lazyload" lazyload="on" alt="Andrew Zhang"></a>
  </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#about">About</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#work">Work</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#blog">Blog</a></h3>
      </div>
    
      <div class="col-xs-3 col-sm-2 nav-item">
        <h3><a href="/personal_website/#contact">Contact</a></h3>
      </div>
    
  <div class="col-xs-6 col-sm-1 nav-toggle">
      <a href="" class="nav-icon" onclick="return false">
        <i id="open" class="icon icon-2x icon-menu"></i>
      </a>
  </div>
</nav>

<section class="nav-full row middle-xs center-xs">
  <div class="col-xs-12">
    <div class="row middle-xs center-xs">
      
        <div class="col-xs-12"><h1><a href="/personal_website/#about">About</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#work">Work</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#blog">Blog</a></h1></div>
      
        <div class="col-xs-12"><h1><a href="/personal_website/#contact">Contact</a></h1></div>
      
    </div>
  </div>
</section>

    <main>

      <section class="container">
        <section class="content">
          <h1> Week 10 - DIY Closed-Loop Stepper </h1>

            <div class="sub-header">
              April 5, 2021 Â· 5 minutes read
            </div>

          <article class="entry-content">
            <p>One of the disadvantages of stepper motors is that they are typically open-loop, meaning that the microcontroller does not get feedback as to the position of the stepper. This is a problem because these motors have generally low torque and can easily skip steps, so errors can build up over many movements and result in undesired behavior. However, commercially available closed-loop steppers are fairly expensive (the cheapest ones I found were about $30). Since I had several 5V 28-BYJ48 steppers from a previous project, I wanted to see if they could be converted to closed-loop steppers by utilizing potentiometers for positional feedback. If successful, this would be a very cost-effective way of getting closed-loop steppers, with the limitation of having a range of motion only about 180 degrees (depending on the potentiometer). In addition, we learned how to use the DRV8835 bipolar stepper drivers with NEMA17 steppers in class, and I wanted to see if I could modify the unipolar 28-BYJ48 steppers so they could use the same driver. The advantage of using the DRV8834 drivers is that it can be controlled by only 2 GPIO pins: one for step rate and one for direction. Moreover, it is claimed that converting the 28-BYJ48 from unipolar to bipolar can triple the torque.</p>
<p>As it turns out, this was fairly simple. I followed this Youtube tutorial:</p>
<p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/pOMRzBdshEY" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


</p>
<p>Basically, to convert the 28-BYJ48 from unipolar to bipolar you just need to open up the blue cover of the motor and cut a groove in the middle trace of the PCB. Then, the blue cover can be replaced and the red wire removed completely. The remaining 4 wires are defined in the following way (<strong><a href="https://www.youtube.com/watch?v=qI2NulbQGOQ">source</a></strong>):</p>
<p><img src="images/week10-stepper/bipolar-wiring.png" alt="28-BYJ48 bipolar mode wiring."></p>
<p>The DRV8834 stepper drivers can be wired like so:</p>
<p><img src="images/week10-stepper/DRV8834-wiring.png" alt="DRV8834 wiring."></p>
<p>Importantly, the current-limiting trimpot on the DRV8834 needs to be adjusted because the 28-BYJ48 steppers run on very little current (100 mA). This can be done by following the instructions on the <strong><a href="https://www.pololu.com/product/2134">product documentation</a></strong>. Afterwards, I wrote a quick script to make the stepper run at a constant speed but with direction controlled by the position of a potentiometer. Here, the motor turns clockwise when the potentiometer value is greater than 92 (on a 0 to 180 mapped scale) and counterclockwise when the potentiometer value is less than 88. The motor is stopped when the potentiometer value is equal to any value in the range [88, 92].</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">const</span> <span class="nb">int</span> <span class="n">pin_step</span> <span class="o">=</span> <span class="n">D1</span><span class="p">;</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">pin_dir</span> <span class="o">=</span> <span class="n">D2</span><span class="p">;</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">pin_encpot</span> <span class="o">=</span> <span class="n">A0</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">val_encpot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">74800</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">pin_step</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">val_encpot</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="n">pin_encpot</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">val_encpot</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">val_encpot</span> <span class="o">&lt;</span> <span class="mi">88</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">motorRun</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">val_encpot</span> <span class="o">&gt;</span> <span class="mi">92</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">motorRun</span><span class="p">();</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="n">void</span> <span class="n">motorRun</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_step</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_step</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div><p><img src="images/week10-stepper/initial-test.gif" alt="Initial test."></p>
<p>Though the modified 28-BYJ48 did spin, it was rather slow. I timed one rotation of the motor at 16 seconds. I do expect this motor to be slower than the NEMA17, because it has a plastic gearbox which results in 2048 steps per rotation. However, less than 4 RPM is too slow. In addition, the torque seemed oddly weak, perhaps even weaker than the unmodified 28-BYJ48. My hypothesis is that this was because I might not be driving the motor in full-step mode, or I somehow set the current limit wrong. This is something that I plan to debug later.</p>
<p>The next step is to couple the rotation of the stepper to the rotation of the potentiometer. I did this in a somewhat hasty fashion using some of the plastic parts from the kit and hot glue. The goal of this setup is so that the potentiometer provides immediate position feedback to the stepper, and therefore the stepper should maintain the position of the potentiometer no matter how the former is rotated. As you can see, this worked surprisingly well:</p>
<p><img src="images/week10-stepper/maintain-position-2.gif" alt="Test 2.">
<img src="images/week10-stepper/maintain-position-1.gif" alt="Test 3."></p>
<p>Next, I added a second potentiometer to control the desired position of the one connected to the motor. This was achieved by reading the control potentiometer from pin A0 and mapping to a range of 0 to 180 degrees, then setting this value to the &ldquo;goal value&rdquo; for the encoding potentiometer (<code>encpot</code>). However, because the NodeMCU only has one ADC pin and I needed to read from two potentiometers at once, I had to multiplex pin A0 again as described in my <strong><a href="https://aspartate.github.io/personal_website/blog/week-9-cloud/">Week 9 post</a></strong>:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">const</span> <span class="nb">int</span> <span class="n">pin_step</span> <span class="o">=</span> <span class="n">D1</span><span class="p">;</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">pin_dir</span> <span class="o">=</span> <span class="n">D2</span><span class="p">;</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">pin_encpot</span> <span class="o">=</span> <span class="n">D3</span><span class="p">;</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">pin_conpot</span> <span class="o">=</span> <span class="n">D4</span><span class="p">;</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">pin_input_pot</span> <span class="o">=</span> <span class="n">A0</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">val_encpot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">val_conpot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">74800</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">pin_step</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  
  <span class="n">pinMode</span><span class="p">(</span><span class="n">pin_encpot</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">pin_conpot</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_encpot</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_conpot</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">val_encpot</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="n">pin_input_pot</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>
  
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_encpot</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_conpot</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">val_conpot</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="n">pin_input_pot</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>

  <span class="n">Serial</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Encoder: &#34;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">val_encpot</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Comntroller: &#34;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">val_conpot</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">val_encpot</span> <span class="o">&lt;</span> <span class="n">val_conpot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">motorRun</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">val_encpot</span> <span class="o">&gt;</span> <span class="n">val_conpot</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_dir</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">motorRun</span><span class="p">();</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="n">void</span> <span class="n">motorRun</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_step</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pin_step</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div><p><img src="images/week10-stepper/finished-1.gif" alt="Finished closed-loop stepper."></p>
<p><img src="images/week10-stepper/finished-2.gif" alt="Finished closed-loop stepper."></p>
<p><img src="images/week10-stepper/wiring.jpg" alt="Finished closed-loop stepper wiring."></p>
<p>As you can see, the proof-of-concept works fairly well. I plan to develop this further, by integrating the potentiometer with the body of the motor via a 3D-printed gearbox. The total cost of such a closed-loop stepper system will be less than $2.</p>

          </article>

          <div class="pagination">
            
              <a href="https://aspartate.github.io/personal_website/blog/week-9-cloud/">&laquo; Week 9 - The Cloud</a>
            
            
              <a href="https://aspartate.github.io/personal_website/blog/avatarm/">Final Project &raquo;</a>
            
          </div>
        </section>
        <br>
        <section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;
      var disqus_shortname = '';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view comments powered by <a href="http://disqus.com/?ref_noscript">Disqus</a>.</noscript>
</section>

      </section>

    </main>
    <footer class="row middle-xs center-xs">
  <div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-facebook"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href="https://github.com/aspartate/personal_website"><i class="icon icon-github"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-linkedin"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-stackoverflow"></i></a>
    </div><div class="col-xs-2">
      <a target="_blank" rel="noopener" href=""><i class="icon icon-twitter"></i></a>
    </div>
  <div class="col-xs-12">
      <small>
      
      Copyright &copy; 2021 Andrew Zhang
      
      
      </small>
    </div>
</footer>

    






  <script src="https://aspartate.github.io/personal_website/js/bundle.min.fbd35181a0fd0238360575e6a25942746d4e73c615f852efe3b975ea70829339.js" type="text/javascript"></script>
  <script>handleNavBar( false )</script>

  </body>
</html>